<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>social-wall-overlay</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: transparent;
      overflow:hidden;
      width:100vw;height:100vh;
    }
    .message-container{
      position:fixed;
      background:rgba(255,255,255,.95);
      border-radius:12px;
      padding:15px;
      box-shadow:0 4px 15px rgba(0,0,0,.2);
      max-width:320px;
      animation:slideIn .5s ease-out;
      transition:all .3s ease;
      z-index:10;
    }
    .message-container:hover{
      transform:scale(1.05);
      box-shadow:0 6px 20px rgba(0,0,0,.3);
    }
    .message-header{display:flex;align-items:center;margin-bottom:10px}
    .avatar{
      width:40px;height:40px;border-radius:50%;
      display:flex;align-items:center;justify-content:center;
      color:#fff;font-weight:700;margin-right:10px;flex-shrink:0;
      user-select:none;
    }
    .username{font-weight:700;color:#333;font-size:14px;user-select:none}
    .message-content{color:#555;font-size:13px;line-height:1.4;white-space:pre-wrap;word-wrap:break-word}

    @keyframes slideIn{from{opacity:0;transform:scale(.8) translateY(20px)}to{opacity:1;transform:scale(1) translateY(0)}}
    @keyframes fadeOut{to{opacity:0;transform:scale(.8)}}
    .fade-out{animation:fadeOut .3s ease-out forwards}

    /* Status panel (siempre visible) */
    #status{
      position:fixed;top:12px;left:12px;
      background:rgba(0,0,0,.8);color:#fff;
      padding:10px 12px;border-radius:8px;
      font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12px;line-height:1.35;
      z-index:9999;max-width:520px;
    }
    #status .ok{color:#5CFF7A}
    #status .warn{color:#FFD65C}
    #status .bad{color:#FF6B6B}
    #status small{opacity:.85}

    /* Bot√≥n test */
    #testBtn{
      position:fixed;bottom:14px;left:14px;
      z-index:9999;
      padding:10px 12px;border-radius:10px;border:0;
      background:rgba(255,255,255,.9);
      cursor:pointer;
      box-shadow:0 4px 12px rgba(0,0,0,.25);
      font-weight:700;
    }
    #testBtn:hover{transform:scale(1.03)}
  </style>
</head>

<body>
  <div id="status">
    <div><strong>Social Wall Overlay</strong></div>
    <div id="stLine1">Iniciando‚Ä¶</div>
    <div id="stLine2"><small>Esperando‚Ä¶</small></div>
  </div>

  <button id="testBtn" title="Crea una burbuja de prueba">+ Test bubble</button>

  <script>
    /********************
     * CONFIG (desde URL)
     ********************/
    const params = new URLSearchParams(location.search);
    const SESSION_ID = params.get("session") || "";  // obligatorio
    const debugMode = params.get("debug") === "1";

    const WS_URL = SESSION_ID
      ? `wss://io.socialstream.ninja/join/${SESSION_ID}/4`
      : "";

    /********************
     * STATUS UI
     ********************/
    const st1 = document.getElementById("stLine1");
    const st2 = document.getElementById("stLine2");

    function setStatus(line1, line2, cls) {
      st1.innerHTML = line1;
      st2.innerHTML = `<small class="${cls || ""}">${line2}</small>`;
      if (debugMode) console.log("[STATUS]", line1, line2);
    }

    /********************
     * WALL SETTINGS
     ********************/
    const messages = [];
    const maxMessages = 20;

    const centerZone = { x: innerWidth/2, y: innerHeight/2, radius: 200 };

    function getRandomColor(){
      const colors = [
        "linear-gradient(135deg,#667eea 0%,#764ba2 100%)",
        "linear-gradient(135deg,#f093fb 0%,#f5576c 100%)",
        "linear-gradient(135deg,#4facfe 0%,#00f2fe 100%)",
        "linear-gradient(135deg,#43e97b 0%,#38f9d7 100%)",
        "linear-gradient(135deg,#fa709a 0%,#fee140 100%)",
        "linear-gradient(135deg,#30cfd0 0%,#330867 100%)",
        "linear-gradient(135deg,#a8edea 0%,#fed6e3 100%)",
        "linear-gradient(135deg,#ff9a9e 0%,#fecfef 100%)"
      ];
      return colors[Math.floor(Math.random()*colors.length)];
    }

    function getRandomPosition(){
      let x, y;
      let attempts = 0;
      while (attempts < 60){
        x = Math.random()*(innerWidth - 350);
        y = Math.random()*(innerHeight - 150);
        const d = Math.hypot(x - centerZone.x, y - centerZone.y);
        if (messages.length < 10 && d > centerZone.radius) return {x,y};
        if (messages.length >= 10) return {x,y};
        attempts++;
      }
      return {x:20,y:80};
    }

    function createMessage(username, content){
      const safeUser = String(username ?? "Usuario").replace(/[<>]/g,"").trim() || "Usuario";
      const safeContent = String(content ?? "").replace(/[<>]/g,"");
      if (!safeContent.trim()) return;

      if (messages.length >= maxMessages){
        const oldest = messages.shift();
        oldest.element.classList.add("fade-out");
        setTimeout(()=> oldest.element?.remove(), 300);
      }

      const div = document.createElement("div");
      div.className = "message-container";

      const pos = getRandomPosition();
      div.style.left = pos.x + "px";
      div.style.top = pos.y + "px";

      const initial = safeUser.charAt(0).toUpperCase() || "?";
      const avatarBg = getRandomColor();

      div.innerHTML = `
        <div class="message-header">
          <div class="avatar" style="background:${avatarBg}">${initial}</div>
          <div class="username">${safeUser}</div>
        </div>
        <div class="message-content">${safeContent}</div>
      `;

      document.body.appendChild(div);
      messages.push({element:div, username:safeUser, content:safeContent});
    }

    /********************
     * TEST BUTTON
     ********************/
    document.getElementById("testBtn").addEventListener("click", () => {
      createMessage("Sistema", "Esto es una burbuja de prueba ‚úÖ");
    });

    /********************
     * SSN WEBSOCKET
     ********************/
    let ws = null;
    let reconnectTimer = null;

    function connect(){
      if (!SESSION_ID){
        setStatus(
          `<span class="bad">‚ùå Falta session</span>`,
          `Abr√≠: ?session=TU_SESSION_ID (ej: ?session=qtgxCBvLbF&debug=1)`,
          "bad"
        );
        return;
      }

      setStatus("üîå Conectando‚Ä¶", WS_URL, "warn");

      try {
        ws = new WebSocket(WS_URL);
      } catch (e){
        setStatus(`<span class="bad">‚ùå WebSocket no creado</span>`, e.message, "bad");
        scheduleReconnect();
        return;
      }

      ws.onopen = () => {
        setStatus(`<span class="ok">‚úÖ Conectado</span>`, `Session: ${SESSION_ID} | Canal: 4`, "ok");
        // burbuja de confirmaci√≥n (√∫til para saber que el overlay dibuja)
        createMessage("Sistema", "Conectado a SSN ‚úÖ (ahora deber√≠an entrar chats)");
      };

      ws.onmessage = (evt) => {
        // Esperamos JSON con chatmessage / chatname, pero toleramos variantes
        let data;
        try {
          data = JSON.parse(evt.data);
        } catch {
          if (debugMode) console.log("WS raw:", evt.data);
          return;
        }

        const username = data.chatname || data.username || data.author || data.name || "Usuario";
        const content  = data.chatmessage || data.message || data.text || data.msg || data.content;

        if (debugMode) console.log("WS event:", data);

        if (content && String(content).trim()){
          createMessage(username, content);
        }
      };

      ws.onerror = () => {
        setStatus(`<span class="bad">‚ùå Error WebSocket</span>`, "Reintentando‚Ä¶", "bad");
      };

      ws.onclose = () => {
        setStatus(`<span class="warn">üîÅ Desconectado</span>`, "Reintentando en 2s‚Ä¶", "warn");
        scheduleReconnect();
      };
    }

    function scheduleReconnect(){
      clearTimeout(reconnectTimer);
      reconnectTimer = setTimeout(connect, 2000);
    }

    /********************
     * INIT
     ********************/
    setStatus("üöÄ Overlay iniciado", SESSION_ID ? `Esperando WS‚Ä¶ session=${SESSION_ID}` : "Falta session en URL", SESSION_ID ? "warn" : "bad");
    connect();

    addEventListener("resize", () => {
      centerZone.x = innerWidth/2;
      centerZone.y = innerHeight/2;
    });
  </script>
</body>
</html>
