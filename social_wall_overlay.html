<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Social Wall Overlay</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body{
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: transparent;
      overflow: hidden;
      width: 100vw;
      height: 100vh;
    }

    .message-container{
      position: fixed;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 12px;
      padding: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      max-width: 320px;
      animation: slideIn 0.5s ease-out;
      transition: all 0.3s ease;
      z-index: 10;
    }

    .message-container:hover{
      transform: scale(1.05);
      box-shadow: 0 6px 20px rgba(0,0,0,0.3);
    }

    .message-header{
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }

    .avatar{
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      margin-right: 10px;
      flex-shrink: 0;
      user-select: none;
    }

    .username{
      font-weight: bold;
      color: #333;
      font-size: 14px;
      user-select: none;
    }

    .message-content{
      color: #555;
      font-size: 13px;
      line-height: 1.4;
      word-wrap: break-word;
      white-space: pre-wrap;
    }

    @keyframes slideIn{
      from{ opacity: 0; transform: scale(0.8) translateY(20px); }
      to{ opacity: 1; transform: scale(1) translateY(0); }
    }

    @keyframes fadeOut{
      to{ opacity: 0; transform: scale(0.8); }
    }

    .fade-out{
      animation: fadeOut 0.3s ease-out forwards;
    }

    #debug{
      position: fixed;
      top: 10px;
      left: 10px;
      background: rgba(0,0,0,0.8);
      color: lime;
      padding: 10px;
      font-family: monospace;
      font-size: 11px;
      border-radius: 5px;
      max-width: 420px;
      z-index: 9999;
      display: none;
      line-height: 1.3;
    }
  </style>
</head>

<body>
  <div id="debug"></div>

  <script>
    /********************
     * CONFIG
     ********************/
    const SESSION_ID = "qtgxCBvLbF"; // <-- tu session
    const WS_URL = `wss://io.socialstream.ninja/join/${SESSION_ID}/4`; // canal 4 = chat broadcast

    // Activ√°/Desactiv√° el debug en pantalla
    let debugMode = true; // true = muestra panel verde | false = oculto

    /********************
     * STATE
     ********************/
    const messages = [];
    const maxMessages = 20;

    // Zona ‚Äúprohibida‚Äù al centro, para que no te tape la cara o algo importante
    const centerZone = {
      x: window.innerWidth / 2,
      y: window.innerHeight / 2,
      radius: 200
    };

    /********************
     * DEBUG
     ********************/
    function debug(msg) {
      console.log(msg);
      if (!debugMode) return;

      const debugDiv = document.getElementById("debug");
      debugDiv.style.display = "block";
      debugDiv.innerHTML += msg + "<br>";

      const lines = debugDiv.innerHTML.split("<br>");
      if (lines.length > 14) {
        debugDiv.innerHTML = lines.slice(-14).join("<br>");
      }
    }

    /********************
     * UI HELPERS
     ********************/
    function getRandomColor() {
      const colors = [
        "linear-gradient(135deg, #667eea 0%, #764ba2 100%)",
        "linear-gradient(135deg, #f093fb 0%, #f5576c 100%)",
        "linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)",
        "linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)",
        "linear-gradient(135deg, #fa709a 0%, #fee140 100%)",
        "linear-gradient(135deg, #30cfd0 0%, #330867 100%)",
        "linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)",
        "linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)"
      ];
      return colors[Math.floor(Math.random() * colors.length)];
    }

    function getRandomPosition() {
      let x, y;
      let attempts = 0;
      const maxAttempts = 60;

      do {
        x = Math.random() * (window.innerWidth - 350);
        y = Math.random() * (window.innerHeight - 150);

        const distanceFromCenter = Math.sqrt(
          Math.pow(x - centerZone.x, 2) + Math.pow(y - centerZone.y, 2)
        );

        // si hay pocos mensajes, evitamos el centro
        if (messages.length < 10 && distanceFromCenter > centerZone.radius) {
          return { x, y };
        }
        // si ya hay muchos, ubicamos donde sea
        if (messages.length >= 10) {
          return { x, y };
        }

        attempts++;
      } while (attempts < maxAttempts);

      return { x, y };
    }

    function createMessage(username, content) {
      // Limpiar HTML b√°sico para evitar inyecciones raras
      const safeUser = String(username ?? "Usuario").replace(/[<>]/g, "");
      const safeContent = String(content ?? "").replace(/[<>]/g, "");

      if (!safeContent.trim()) return;

      if (messages.length >= maxMessages) {
        const oldestMessage = messages.shift();
        oldestMessage.element.classList.add("fade-out");
        setTimeout(() => {
          if (oldestMessage.element?.parentNode) oldestMessage.element.remove();
        }, 300);
      }

      const messageDiv = document.createElement("div");
      messageDiv.className = "message-container";

      const position = getRandomPosition();
      messageDiv.style.left = position.x + "px";
      messageDiv.style.top = position.y + "px";

      const initial = safeUser.charAt(0).toUpperCase() || "?";
      const avatarColor = getRandomColor();

      messageDiv.innerHTML = `
        <div class="message-header">
          <div class="avatar" style="background:${avatarColor}">${initial}</div>
          <div class="username">${safeUser}</div>
        </div>
        <div class="message-content">${safeContent}</div>
      `;

      document.body.appendChild(messageDiv);
      messages.push({ element: messageDiv, username: safeUser, content: safeContent });

      debug(`‚úì Mensaje: ${safeUser}: ${safeContent.substring(0, 60)}`);
    }

    /********************
     * SSN WEBSOCKET
     ********************/
    function connectSSN() {
      debug("üîå Conectando a SSN WS‚Ä¶");
      debug(`üåê ${WS_URL}`);

      let ws;
      try {
        ws = new WebSocket(WS_URL);
      } catch (e) {
        debug("‚ùå No se pudo crear WebSocket: " + e.message);
        setTimeout(connectSSN, 2000);
        return;
      }

      ws.onopen = () => {
        debug("‚úÖ WebSocket conectado (canal 4).");
        debug("‚ö†Ô∏è Asegurate de activar en SSN: Toggle 1 y Toggle 3 (Send chat messages to API server).");
      };

      ws.onmessage = (evt) => {
        // SSN env√≠a JSON. A veces llegan mensajes que no son chat; los filtramos.
        try {
          const data = JSON.parse(evt.data);

          // Campos t√≠picos
          const username =
            data.chatname || data.username || data.author || data.name || "Usuario";

          const content =
            data.chatmessage || data.message || data.text || data.msg || data.content;

          // Algunos eventos vienen con `type`; si quer√©s filtrar fuerte:
          // if (data.type && data.type !== "chatmessage") return;

          if (content && String(content).trim()) {
            createMessage(username, content);
          } else {
            debug("‚ö†Ô∏è Evento recibido sin contenido de chat.");
          }
        } catch (e) {
          debug("‚ö†Ô∏è Mensaje no-JSON o error parseando: " + e.message);
        }
      };

      ws.onerror = () => {
        debug("‚ùå WebSocket error.");
      };

      ws.onclose = () => {
        debug("üîÅ WebSocket cerrado. Reintentando en 2 segundos‚Ä¶");
        setTimeout(connectSSN, 2000);
      };
    }

    /********************
     * INIT
     ********************/
    debug("üöÄ Overlay iniciado");
    connectSSN();

    // Mensajes de prueba (pod√©s comentar si quer√©s)
    setTimeout(() => createMessage("Ken Lee", "¬°Incre√≠ble presentaci√≥n! üéâ"), 800);
    setTimeout(() => createMessage("Steven Black", "HECK YEAH"), 1400);
    setTimeout(() => createMessage("Kristian Brandt", "I'm so excited! üé¨"), 2000);
    setTimeout(() => createMessage("Fitzroy Sam", "Amazing! üòç"), 2600);

    // Test manual desde consola:
    window.testMessage = function(u, m) {
      createMessage(u || "Test User", m || "Test message");
    };
    debug('üí° Consola: testMessage("Nombre","Mensaje")');

    // Si redimension√°s la ventana, recalculamos el centro
    window.addEventListener("resize", () => {
      centerZone.x = window.innerWidth / 2;
      centerZone.y = window.innerHeight / 2;
      debug("üìê Resize: rec√°lculo centerZone");
    });
  </script>
</body>
</html>
